<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dar de baja un producto · JR Químicos</title>
  <link rel="stylesheet" href="../styles.css" />
  <!-- Header/Footer globales -->
  <script type="module" src="../ui/shell.js"></script>
</head>
<body>
  <!-- Header global (no repetir markup en cada página) -->
  <jrq-header prefix="../" active="Inventario"></jrq-header> 

  <main class="container" role="main">
    <!-- Botonera -->
    <section class="card" style="margin-top:18px" aria-label="Navegación Inventario">
      <div class="row" style="align-items:center">
        <a class="btn mid" href="(p) registrar-producto.html">Registrar Producto</a>
        <a class="btn mid" href="stock-producto.html">Mostrar Productos</a>
        <a class="btn mid" href="modificar-producto.html">Modificar Producto</a>
        <a class="btn" href="baja-producto.html" aria-current="page">Dar de Baja un Producto</a>
      </div>
    </section>

    <!-- Filtros -->
    <section class="card" style="margin-top:18px">
      <h1>Dar de Baja un Producto</h1>
      <form id="de-filtros" class="row" autocomplete="off">
        <div><label for="de-id">ID</label><input id="de-id" type="text" placeholder="EG-2025-0010" /></div>
        <div><label for="de-desde">Desde</label><input id="de-desde" type="date" /></div>
        <div><label for="de-hasta">Hasta</label><input id="de-hasta" type="date" /></div>
        <div>
          <label for="de-tipo">Tipo</label>
          <select id="de-tipo">
            <option value="">(Todos)</option>
            <option>Venta</option>
            <option>Consumo interno</option>
            <option>Ajuste</option>
            <option>Devolución a proveedor</option>
          </select>
        </div>
        <div class="grow">
          <label for="de-resp">Responsable</label>
          <select id="de-resp"><option value="">(Todos)</option></select>
        </div>
        <div style="flex:0 0 auto; align-self:end">
          <button class="btn" type="submit">Buscar</button>
          <button class="btn mid" type="reset">Limpiar</button>
        </div>
      </form>
    </section>

    <!-- Listado con ÚNICO botón rojo “Seleccionar” -->
    <section class="card" style="margin-top:12px">
      <h2>Resultados</h2>
      <table class="table" aria-describedby="de-ayuda">
        <thead>
          <tr>
            <th>ID</th>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Producto</th>
            <th>Cant.</th>
            <th>Resp.</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody id="de-body"><!-- filas dinámicas --></tbody>
      </table>

      <div id="de-empty" class="alert" style="display:none">No hay egresos con los filtros aplicados.</div>
      <p id="de-ayuda" class="small muted" style="margin-top:10px">
        Usa el botón <b>Seleccionar</b> para cargar el registro en el formulario de confirmación.
      </p>

      <!-- Plantilla estándar para clonar filas -->
      <template id="tpl-de-row">
        <tr>
          <td data-col="id"></td>
          <td data-col="fec"></td>
          <td data-col="tip"></td>
          <td data-col="prod"></td>
          <td data-col="cant"></td>
          <td data-col="resp"></td>
          <td data-col="accion">
            <!-- ÚNICO botón rojo de selección (formato guardado) -->
            <button class="btn danger de-select"
                    data-id=""
                    data-fec=""
                    data-tip=""
                    data-prod=""
                    data-cant=""
                    data-resp="">
              Seleccionar
            </button>
          </td>
        </tr>
      </template>
    </section>

    <!-- Confirmación (dos botones estandarizados) -->
    <section class="card" style="margin-top:12px">
      <h2>Confirmación</h2>
      <form id="de-form" class="grid cols-2" autocomplete="off">
        <div>
          <div class="row">
            <div><label for="de-sel-id">ID</label><input id="de-sel-id" type="text" readonly /></div>
            <div><label for="de-sel-fecha">Fecha</label><input id="de-sel-fecha" type="date" readonly /></div>
          </div>
          <div class="row">
            <div class="grow"><label for="de-sel-prod">Producto</label><input id="de-sel-prod" type="text" readonly /></div>
            <div><label for="de-sel-cant">Cantidad</label><input id="de-sel-cant" type="number" readonly /></div>
          </div>
          <div class="row">
            <div><label for="de-sel-tipo">Tipo</label><input id="de-sel-tipo" type="text" readonly /></div>
            <div class="grow"><label for="de-sel-resp">Responsable</label><input id="de-sel-resp" type="text" readonly /></div>
          </div>
        </div>
        <aside>
          <div class="row">
            <div class="grow">
              <label for="de-motivo">Motivo (obligatorio)</label>
              <input id="de-motivo" type="text" placeholder="Justificación de la eliminación" />
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <!-- Botones con el formato guardado -->
            <button class="btn danger" type="submit" id="de-baja">Dar de Baja Definitivamente</button>
          </div>
          
        </aside>
      </form>
    </section>

    <hr />
  </main>

  <!-- Footer global -->
  <jrq-footer context="Eliminar Egresos"></jrq-footer>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

 <script>
(() => {
  // ===== Config =====
  const CATALOGO_VERSION = "productos.v3"; // súbelo para forzar actualización del catálogo
  const qs  = (s, el=document) => el.querySelector(s);
  const qsa = (s, el=document) => [...el.querySelectorAll(s)];
  const toast = (msg) => { const el = qs('#toast'); if(!el) return; el.textContent = msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), 1800); };

  const storage = {
    get(k, fb){ try { return JSON.parse(localStorage.getItem(k)) ?? fb; } catch { return fb; } },
    set(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
  };

  // ===== Catálogo normalizado (mismo que en las otras pantallas) =====
  const CATALOGO = [
    // Insumos
    { id: 'PR-0001', nombre: 'PR-0001. Ácido cítrico',        tipo: 'insumo',   costo: 12.50, stock:  80 },
    { id: 'PR-0002', nombre: 'PR-0002. Peróxido técnico',     tipo: 'insumo',   costo:  9.10, stock: 120 },
    { id: 'PR-0003', nombre: 'PR-0003. Envase PET 1L',        tipo: 'insumo',   costo:  1.30, stock: 500 },
    { id: 'PR-0004', nombre: 'PR-0004. Hipoclorito 5%',       tipo: 'insumo',   costo:  5.50, stock: 120 },
    { id: 'PR-0005', nombre: 'PR-0005. Tensoactivo X',        tipo: 'insumo',   costo: 18.00, stock:  70 },
    { id: 'PR-0006', nombre: 'PR-0006. Fragancia Floral',     tipo: 'insumo',   costo: 41.50, stock:  15 },
    { id: 'PR-0007', nombre: 'PR-0007. Envase PET 1L',        tipo: 'insumo',   costo:  0.78, stock: 800 },
    // Productos terminados
    { id: 'PR-0101', nombre: 'PR-0101. Detergente Multiusos 1L', tipo: 'producto', costo:  7.80, stock:  60 },
    { id: 'PR-0102', nombre: 'PR-0102. Lejía 5% 1L',              tipo: 'producto', costo:  5.40, stock:  75 },
    { id: 'PR-0103', nombre: 'PR-0103. Detergente 1L',            tipo: 'producto', costo: 11.90, stock: 200 },
    { id: 'PR-0104', nombre: 'PR-0104. Lavavajilla 500ml',        tipo: 'producto', costo:  3.50, stock: 180 },
    { id: 'PR-0105', nombre: 'PR-0105. Limpiavidrios 500',        tipo: 'producto', costo:  4.10, stock: 140 }
  ];

  // ===== Seeds =====
  function seedOnce(){
    // Empleados
    if (!storage.get('empleados')) {
      storage.set('empleados', [
        { id: 'T-0001', nombre: 'María Rojas' },
        { id: 'T-0002', nombre: 'Carlos Díaz' },
        { id: 'T-0003', nombre: 'Ana Gómez' }
      ]);
    }
    // Productos por versión
    const ver = storage.get('catalogo_version');
    if (!storage.get('productos') || ver !== CATALOGO_VERSION) {
      storage.set('productos', CATALOGO);
      storage.set('catalogo_version', CATALOGO_VERSION);
    }
    // Egresos demo (ID del egreso = ID del producto)
    if (!storage.get('egresos')) {
      const hoy = new Date();
      const iso = (d)=>d.toISOString().slice(0,10);
      const d = (off)=>{ const x=new Date(hoy); x.setDate(x.getDate()+off); return x; };
      storage.set('egresos', [
        { id:'PR-0101', fecha: iso(d(-12)), prodId:'PR-0101', cant:  8, respId:'T-0001', obs:'Pedido cliente A' },
        { id:'PR-0004', fecha: iso(d(-11)), prodId:'PR-0004', cant:  5, respId:'T-0002', obs:'Limpieza planta' },
        { id:'PR-0102', fecha: iso(d(-9)),  prodId:'PR-0102', cant: 12, respId:'T-0003', obs:'Cliente B (nota 145)' },
        { id:'PR-0007', fecha: iso(d(-7)),  prodId:'PR-0007', cant: 10, respId:'T-0001', obs:'Ajuste inventario' },
        { id:'PR-0006', fecha: iso(d(-3)),  prodId:'PR-0006', cant:  2, respId:'T-0002', obs:'Fragancia defectuosa' },
        { id:'PR-0103', fecha: iso(d(-1)),  prodId:'PR-0103', cant:  6, respId:'T-0001', obs:'Cliente C' }
      ]);
    }
  }

  // ===== Data helpers =====
  const getEmpleados = () => storage.get('empleados', []);
  const getProductos = () => storage.get('productos', []);
  const getEgresos   = () => storage.get('egresos', []);
  const saveEgresos  = (arr) => storage.set('egresos', arr);
  const saveProductos= (arr) => storage.set('productos', arr);

  const prodById = (id) => getProductos().find(p=>p.id===id);
  const empById  = (id) => getEmpleados().find(e=>e.id===id);
  const tipoUI   = (p) => p?.tipo === 'producto' ? 'producto terminado' : 'insumo';
  const inRange  = (d, min, max) => (!min || d >= min) && (!max || d <= max);

  // ===== UI: filtros =====
  function setDefaultDates(){
    const fDesde = qs('#de-desde');
    const fHasta = qs('#de-hasta');
    const now = new Date();
    const y = now.getFullYear(), m = now.getMonth();
    const pad = (n)=>String(n).padStart(2,'0');
    const firstOfMonth = `${y}-${pad(m+1)}-01`;
    const today = `${y}-${pad(m+1)}-${pad(now.getDate())}`;
    if (fDesde && !fDesde.value) fDesde.value = firstOfMonth;
    if (fHasta && !fHasta.value) fHasta.value = today;
  }

  function renderResponsablesFiltro(){
    const sel = qs('#de-resp');
    if (!sel) return;
    const current = sel.value;
    sel.innerHTML = '<option value="">(Todos)</option>';
    getEmpleados().forEach(e=>{
      const opt = document.createElement('option');
      opt.value = e.id;
      opt.textContent = `${e.nombre} (${e.id})`;
      sel.appendChild(opt);
    });
    if ([...sel.options].some(o=>o.value===current)) sel.value = current;
  }

  // Reemplazar opciones del filtro Tipo por (Todos | insumo | producto terminado)
  function renderTiposFiltro(){
    const sel = qs('#de-tipo');
    if (!sel) return;
    const current = (sel.value || '').toLowerCase();
    sel.innerHTML = `
      <option value="">(Todos)</option>
      <option value="insumo">insumo</option>
      <option value="producto terminado">producto terminado</option>
    `;
    if ([...sel.options].some(o=>o.value===current)) sel.value = current;
  }

  // ===== Render listado =====
  function applyFilters(){
    const fId   = (qs('#de-id').value || '').trim().toUpperCase();
    const desde = qs('#de-desde').value || '';
    const hasta = qs('#de-hasta').value || '';
    const fTipo = (qs('#de-tipo').value || '').trim().toLowerCase();
    const fResp = (qs('#de-resp').value || '').trim();

    let rows = getEgresos().filter(r=>{
      const p = prodById(r.prodId);
      const t = tipoUI(p); // "insumo" | "producto terminado"
      const okId   = !fId || r.prodId.includes(fId) || r.id.includes(fId);
      const okFe   = inRange(r.fecha, desde, hasta);
      const okTipo = !fTipo || t === fTipo;
      const okResp = !fResp || r.respId === fResp;
      return okId && okFe && okTipo && okResp;
    });

    rows.sort((a,b)=> (a.fecha < b.fecha ? 1 : a.fecha > b.fecha ? -1 : a.prodId.localeCompare(b.prodId)));
    renderTable(rows);
  }

  function renderTable(rows){
    const tbody = qs('#de-body');
    const empty = qs('#de-empty');
    const tpl   = qs('#tpl-de-row');
    tbody.innerHTML = '';
    if (!rows.length){
      empty.style.display = 'block';
      return;
    }
    empty.style.display = 'none';

    rows.forEach(r=>{
      const p = prodById(r.prodId);
      const e = empById(r.respId);
      const clone = document.importNode(tpl.content, true);
      clone.querySelector('[data-col="id"]').textContent   = r.prodId; // ID = ID de producto
      clone.querySelector('[data-col="fec"]').textContent  = r.fecha;
      clone.querySelector('[data-col="tip"]').textContent  = tipoUI(p);
      clone.querySelector('[data-col="prod"]').textContent = p ? p.nombre : r.prodId;
      clone.querySelector('[data-col="cant"]').textContent = r.cant;
      clone.querySelector('[data-col="resp"]').textContent = e ? e.nombre : r.respId;

      const btn = clone.querySelector('.de-select');
      btn.dataset.id   = r.prodId;
      btn.dataset.fec  = r.fecha;
      btn.dataset.tip  = tipoUI(p);
      btn.dataset.prod = p ? p.nombre : r.prodId;
      btn.dataset.cant = r.cant;
      btn.dataset.resp = e ? `${e.nombre} (${r.respId})` : r.respId;

      tbody.appendChild(clone);
    });

    // Wire único botón rojo Seleccionar
    qsa('.de-select', tbody).forEach(btn=>{
      btn.addEventListener('click', ()=>{
        qs('#de-sel-id').value    = btn.dataset.id;
        qs('#de-sel-fecha').value = btn.dataset.fec;
        qs('#de-sel-tipo').value  = btn.dataset.tip;
        qs('#de-sel-prod').value  = btn.dataset.prod;
        qs('#de-sel-cant').value  = btn.dataset.cant;
        qs('#de-sel-resp').value  = btn.dataset.resp;
        toast('Registro cargado para confirmación');
      });
    });
  }

  // ===== Confirmación =====
  function ensureInactivarButton(){
    // Agregar botón “Marcar como Inactivo” al lado de “Dar de Baja…” si no existe
    const bajaBtn = qs('#de-baja');
    if (!bajaBtn) return;
    if (!qs('#de-inactivar')){
      const inactiveBtn = document.createElement('button');
      inactiveBtn.id = 'de-inactivar';
      inactiveBtn.type = 'button';
      inactiveBtn.className = 'btn mid';
      inactiveBtn.textContent = 'Marcar como Inactivo';
      bajaBtn.parentElement.appendChild(inactiveBtn);
    }
  }

  function getSelectedRow(){
    const prodId = qs('#de-sel-id').value;
    const fecha  = qs('#de-sel-fecha').value;
    if (!prodId || !fecha) return null;
    const rows = getEgresos();
    return { rows, idx: rows.findIndex(x=>x.prodId===prodId && x.fecha===fecha) };
  }

  // Dar de baja definitivamente: repone stock y elimina registro
  function onSubmitBaja(e){
    e.preventDefault();
    const motivo = (qs('#de-motivo').value || '').trim();
    if (!motivo){ toast('Indica el motivo de la baja.'); return; }

    const ref = getSelectedRow();
    if (!ref || ref.idx === -1){ toast('Selecciona un registro primero.'); return; }

    const eg = ref.rows[ref.idx];
    const prods = getProductos();
    const p = prods.find(pp=>pp.id === eg.prodId);
    if (p){
      // egreso previo restó stock; al dar de baja lo reponemos
      p.stock = +(Number(p.stock) + Number(eg.cant)).toFixed(2);
      saveProductos(prods);
    }

    // eliminar registro
    ref.rows.splice(ref.idx, 1);
    saveEgresos(ref.rows);

    // limpiar formulario
    qs('#de-form').reset();
    toast('Registro dado de baja y stock repuesto');
    applyFilters();
  }

  // Marcar como inactivo: NO repone stock; conserva registro con estado
  function onInactivar(){
    const ref = getSelectedRow();
    if (!ref || ref.idx === -1){ toast('Selecciona un registro primero.'); return; }
    ref.rows[ref.idx].estado = 'Inactivo';
    ref.rows[ref.idx].motivo_inactivo = (qs('#de-motivo').value || '').trim();
    saveEgresos(ref.rows);
    toast('Registro marcado como Inactivo');
    applyFilters();
  }

  // ===== Init =====
  function init(){
    seedOnce();
    renderTiposFiltro();
    renderResponsablesFiltro();
    setDefaultDates();

    // Filtros
    qs('#de-filtros').addEventListener('submit', e=>{ e.preventDefault(); applyFilters(); });
    qs('#de-filtros').addEventListener('reset', ()=>{
      setTimeout(()=>{ renderTiposFiltro(); renderResponsablesFiltro(); setDefaultDates(); applyFilters(); }, 0);
    });

    // Confirmación
    ensureInactivarButton();
    qs('#de-form').addEventListener('submit', onSubmitBaja);
    const inactBtn = () => qs('#de-inactivar');
    if (inactBtn()) inactBtn().addEventListener('click', onInactivar);

    // Primera carga
    applyFilters();
  }

  document.addEventListener('DOMContentLoaded', init);
})();
</script>


</body>
</html>
