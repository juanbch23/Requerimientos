<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Modificar producto · JR Químicos</title>
  <link rel="stylesheet" href="../styles.css" />
  <!-- Header/Footer globales -->
  <script type="module" src="../ui/shell.js"></script>
</head>
<body>
  <!-- Header global (no repetir markup en cada página) -->
  <jrq-header prefix="../" active="Inventario"></jrq-header> 

  <main class="container" role="main">
    <!-- Botonera local -->
    <section class="card" style="margin-top:18px">
      <div class="row" style="align-items:center">
        <a class="btn mid" href="(p) registrar-producto.html">Registrar Producto</a>
        <a class="btn mid" href="stock-producto.html">Mostrar Productos</a>
        <a class="btn" href="modificar-producto.html" aria-current="page">Modificar Producto</a>
        <a class="btn mid" href="baja-producto.html">Dar de Baja un Producto</a>
      </div>
    </section>

    <section class="card" style="margin-top:18px">
      <h1>Filtro de Productos</h1>
      <form id="me-filtros" class="row" autocomplete="off" aria-label="Filtros de búsqueda">
        <div><label for="me-id">ID</label><input id="me-id" type="text" placeholder="PR-00XX" /></div>
        <div><label for="me-desde">Desde</label><input id="me-desde" type="date" /></div>
        <div><label for="me-hasta">Hasta</label><input id="me-hasta" type="date" /></div>
        <div><label for="me-tipo">Tipo</label>
          <select id="me-tipo">
            <option value="">(Todos)</option>
            <option>Insumo</option>
            <option>Producto Fabricado</option>
          </select>
        </div>
        <div class="grow">
          <label for="me-resp">Responsable</label>
          <select id="me-resp"><option value="">(Todos)</option></select>
        </div>
        <div style="flex:0 0 auto; align-self:end">
          <button class="btn" type="submit">Buscar</button>
          <button class="btn mid" type="reset">Limpiar</button>
        </div>
      </form>
    </section>

    <section class="card" style="margin-top:12px">
      <h2>Resultados</h2>
      <table class="table" aria-describedby="me-help">
        <thead>
          <tr>
            <th>ID</th>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Producto</th>
            <th>Cant.</th>
            <th>Resp.</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody id="me-body"></tbody>
      </table>
      <div id="me-empty" class="alert" style="display:none">No hay productos para los filtros aplicados.</div>
      <p id="me-help" class="small muted" style="margin-top:8px">
        Pulsa <b>Seleccionar</b> para cargar el registro en el formulario de edición.
      </p>

      <!-- Plantilla opcional para clonar filas (si quieres usarla desde tu JS) -->
      <template id="tpl-me-row">
        <tr>
          <td data-col="id"></td>
          <td data-col="fecha"></td>
          <td data-col="tipo"></td>
          <td data-col="prod"></td>
          <td data-col="cant"></td>
          <td data-col="resp"></td>
          <td data-col="accion">
            <button type="button" class="btn mid me-sel">Seleccionar</button>
          </td>
        </tr>
      </template>
    </section>

    <section class="card" style="margin-top:12px">
      <h2>Edición</h2>
      <form id="me-form" class="grid cols-2" autocomplete="off" aria-label="Formulario de edición">
        <div>
          <div class="row">
            <div><label for="me-eid">ID</label><input id="me-eid" type="text" readonly /></div>
            <div><label for="me-fecha">Fecha</label><input id="me-fecha" type="date" /></div>
          </div>
          <div class="row">
            <div class="grow"><label for="me-prod">Producto</label><input id="me-prod" type="text" /></div>
            <div><label for="me-cant">Cantidad</label><input id="me-cant" type="number" min="1" /></div>
          </div>
          <div class="row">
            <div><label for="me-tipo-edit">Tipo</label>
              <select id="me-tipo-edit">
                <option>Insumo</option>
                <option>Producto Fabricado</option>
              </select>
            </div>
            <div class="grow"><label for="me-resp-edit">Responsable</label><select id="me-resp-edit"></select></div>
          </div>
          <div class="row">
            <div class="grow"><label for="me-obs">Observación</label><input id="me-obs" type="text" /></div>
          </div>
        </div>
        <aside>
          <div class="row" style="margin-top:8px">
            <button class="btn" type="submit">Guardar cambios</button>
            <button class="btn mid" type="button" id="me-cancel">Cancelar</button>
          </div>
          <p class="small muted">Validar stock y consistencia antes de guardar en producción.</p>
        </aside>
      </form>
    </section>

    <hr />
  </main>

  <!-- Footer global -->
  <jrq-footer context="Modificar Producto"></jrq-footer>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>
<script>
(() => {
  // ========= Configuración =========
  const CATALOGO_VERSION = "productos.v3"; // súbelo para forzar actualización del catálogo
  const qs  = (s, el=document) => el.querySelector(s);
  const qsa = (s, el=document) => [...el.querySelectorAll(s)];
  const toast = (msg) => { const el = qs('#toast'); if(!el) return; el.textContent = msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), 1800); };

  const storage = {
    get(k, fb){ try { return JSON.parse(localStorage.getItem(k)) ?? fb; } catch { return fb; } },
    set(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
  };

  // ========= Catálogo normalizado (mismo que usamos en las otras pantallas) =========
  const CATALOGO = [
    // Insumos
    { id: 'PR-0001', nombre: 'PR-0001. Ácido cítrico',        tipo: 'insumo',   costo: 12.50, stock:  80 },
    { id: 'PR-0002', nombre: 'PR-0002. Peróxido técnico',     tipo: 'insumo',   costo:  9.10, stock: 120 },
    { id: 'PR-0003', nombre: 'PR-0003. Envase PET 1L',        tipo: 'insumo',   costo:  1.30, stock: 500 },
    { id: 'PR-0004', nombre: 'PR-0004. Hipoclorito 5%',       tipo: 'insumo',   costo:  5.50, stock: 120 },
    { id: 'PR-0005', nombre: 'PR-0005. Tensoactivo X',        tipo: 'insumo',   costo: 18.00, stock:  70 },
    { id: 'PR-0006', nombre: 'PR-0006. Fragancia Floral',     tipo: 'insumo',   costo: 41.50, stock:  15 },
    { id: 'PR-0007', nombre: 'PR-0007. Envase PET 1L',        tipo: 'insumo',   costo:  0.78, stock: 800 },
    // Productos terminados
    { id: 'PR-0101', nombre: 'PR-0101. Detergente Multiusos 1L', tipo: 'producto', costo:  7.80, stock:  60 },
    { id: 'PR-0102', nombre: 'PR-0102. Lejía 5% 1L',              tipo: 'producto', costo:  5.40, stock:  75 },
    { id: 'PR-0103', nombre: 'PR-0103. Detergente 1L',            tipo: 'producto', costo: 11.90, stock: 200 },
    { id: 'PR-0104', nombre: 'PR-0104. Lavavajilla 500ml',        tipo: 'producto', costo:  3.50, stock: 180 },
    { id: 'PR-0105', nombre: 'PR-0105. Limpiavidrios 500',        tipo: 'producto', costo:  4.10, stock: 140 }
  ];

  // ========= Seeds / Datos demo =========
  function seedOnce(){
    // Empleados
    if (!storage.get('empleados')) {
      storage.set('empleados', [
        { id: 'T-0001', nombre: 'María Rojas' },
        { id: 'T-0002', nombre: 'Carlos Díaz' },
        { id: 'T-0003', nombre: 'Ana Gómez' }
      ]);
    }
    // Catálogo por versión
    const ver = storage.get('catalogo_version');
    if (!storage.get('productos') || ver !== CATALOGO_VERSION) {
      storage.set('productos', CATALOGO);
      storage.set('catalogo_version', CATALOGO_VERSION);
    }
    // Egresos demo si no hay (ID del egreso = ID del producto)
    if (!storage.get('egresos')) {
      const hoy = new Date();
      const iso = (d)=>d.toISOString().slice(0,10);
      const d = (off)=>{ const x=new Date(hoy); x.setDate(x.getDate()+off); return x; };
      storage.set('egresos', [
        { id:'PR-0101', fecha: iso(d(-12)), prodId:'PR-0101', cant:  8, respId:'T-0001', obs:'Pedido cliente A' },
        { id:'PR-0004', fecha: iso(d(-11)), prodId:'PR-0004', cant:  5, respId:'T-0002', obs:'Limpieza planta' },
        { id:'PR-0102', fecha: iso(d(-9)),  prodId:'PR-0102', cant: 12, respId:'T-0003', obs:'Cliente B (nota 145)' },
        { id:'PR-0007', fecha: iso(d(-7)),  prodId:'PR-0007', cant: 10, respId:'T-0001', obs:'Ajuste inventario' },
        { id:'PR-0006', fecha: iso(d(-3)),  prodId:'PR-0006', cant:  2, respId:'T-0002', obs:'Fragancia defectuosa' },
        { id:'PR-0103', fecha: iso(d(-1)),  prodId:'PR-0103', cant:  6, respId:'T-0001', obs:'Cliente C' }
      ]);
    }
  }

  // ========= Getters =========
  const getEmpleados = () => storage.get('empleados', []);
  const getProductos = () => storage.get('productos', []);
  const getEgresos   = () => storage.get('egresos', []);
  const saveEgresos  = (arr) => storage.set('egresos', arr);
  const saveProductos= (arr) => storage.set('productos', arr);

  const prodById = (id) => getProductos().find(p=>p.id===id);
  const empById  = (id) => getEmpleados().find(e=>e.id===id);

  // ========= UI helpers =========
  function setDefaultDates(){
    const fDesde = qs('#me-desde');
    const fHasta = qs('#me-hasta');
    const now = new Date();
    const y = now.getFullYear(), m = now.getMonth();
    const pad = (n)=>String(n).padStart(2,'0');
    const firstOfMonth = `${y}-${pad(m+1)}-01`;
    const today = `${y}-${pad(m+1)}-${pad(now.getDate())}`;
    if (fDesde && !fDesde.value) fDesde.value = firstOfMonth;
    if (fHasta && !fHasta.value) fHasta.value = today;
  }

  // Filtro Tipo: usar solo “insumo” y “producto terminado”
  function renderTiposFiltro(){
    const sel = qs('#me-tipo');
    if (!sel) return;
    const current = sel.value.toLowerCase();
    sel.innerHTML = `
      <option value="">(Todos)</option>
      <option value="insumo">insumo</option>
      <option value="producto terminado">producto terminado</option>
    `;
    if ([...sel.options].some(o=>o.value===current)) sel.value = current;
  }

  function renderResponsablesFiltro(){
    const sel = qs('#me-resp');
    if (!sel) return;
    const current = sel.value;
    sel.innerHTML = '<option value="">(Todos)</option>';
    getEmpleados().forEach(e=>{
      const opt = document.createElement('option');
      opt.value = e.id;
      opt.textContent = `${e.nombre} (${e.id})`;
      sel.appendChild(opt);
    });
    if ([...sel.options].some(o=>o.value===current)) sel.value = current;
  }

  const tipoUI = (p) => p?.tipo === 'producto' ? 'producto terminado' : 'insumo';
  const inRange = (d, min, max) => (!min || d >= min) && (!max || d <= max);

  // ========= Búsqueda / Resultados =========
  function applyFilters(){
    const fId    = (qs('#me-id').value || '').trim().toUpperCase();
    const desde  = qs('#me-desde').value || '';
    const hasta  = qs('#me-hasta').value || '';
    const fTipo  = (qs('#me-tipo').value || '').trim().toLowerCase(); // "" | "insumo" | "producto terminado"
    const fResp  = (qs('#me-resp').value || '').trim();

    let rows = getEgresos().filter(r=>{
      const p = prodById(r.prodId);
      const t = tipoUI(p);
      const okId   = !fId || r.prodId.includes(fId);
      const okFe   = inRange(r.fecha, desde, hasta);
      const okTipo = !fTipo || t === fTipo;
      const okResp = !fResp || r.respId === fResp;
      return okId && okFe && okTipo && okResp;
    });

    rows.sort((a,b)=> (a.fecha < b.fecha ? 1 : a.fecha > b.fecha ? -1 : a.prodId.localeCompare(b.prodId)));
    renderTable(rows);
  }

  function renderTable(rows){
    const tbody = qs('#me-body');
    const empty = qs('#me-empty');
    tbody.innerHTML = '';
    if (!rows.length){
      empty.style.display = 'block';
      return;
    }
    empty.style.display = 'none';

    rows.forEach(r=>{
      const tr = document.createElement('tr');
      const p  = prodById(r.prodId);
      const e  = empById(r.respId);
      tr.innerHTML = `
        <td>${r.prodId}</td>
        <td>${r.fecha}</td>
        <td>${tipoUI(p)}</td>
        <td>${p ? p.nombre : r.prodId}</td>
        <td>${r.cant}</td>
        <td>${e ? e.nombre : r.respId}</td>
        <td><button type="button" class="btn mid me-sel" data-id="${r.prodId}" data-fecha="${r.fecha}">Seleccionar</button></td>
      `;
      tbody.appendChild(tr);
    });

    qsa('.me-sel', tbody).forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-id');
        const fecha = btn.getAttribute('data-fecha');
        const row = getEgresos().find(x=>x.prodId===id && x.fecha===fecha) || getEgresos().find(x=>x.prodId===id);
        if (!row) return;
        loadForm(row);
        toast('Registro cargado para edición');
      });
    });
  }

  // ========= Edición =========
  let currentKey = null; // { prodId, fecha } para localizar el registro original

  function renderResponsablesEdicion(){
    const sel = qs('#me-resp-edit');
    if (!sel) return;
    sel.innerHTML = '';
    getEmpleados().forEach(e=>{
      const opt = document.createElement('option');
      opt.value = e.id;
      opt.textContent = `${e.nombre} (${e.id})`;
      sel.appendChild(opt);
    });
  }

  function loadForm(r){
    currentKey = { prodId: r.prodId, fecha: r.fecha };
    const p = prodById(r.prodId);
    qs('#me-eid').value   = r.prodId;         // ID (readonly)
    qs('#me-fecha').value = r.fecha;          // Fecha
    qs('#me-prod').value  = p ? p.nombre : r.prodId;  // Nombre visible
    qs('#me-cant').value  = r.cant;           // Cantidad
    // Tipo (UI) — bloqueamos para mantener consistencia con el catálogo
    const selTipo = qs('#me-tipo-edit');
    selTipo.value = (p?.tipo === 'producto') ? 'Producto Fabricado' : 'Insumo';
    selTipo.disabled = true;

    // Responsable
    renderResponsablesEdicion();
    qs('#me-resp-edit').value = r.respId;
    // Observación
    qs('#me-obs').value = r.obs || '';
  }

  function saveForm(e){
    e.preventDefault();
    if (!currentKey){ toast('Primero selecciona un registro.'); return; }

    const prodId = qs('#me-eid').value;
    const nuevaFecha = qs('#me-fecha').value;
    const nuevaCant  = Math.max(0, parseFloat(qs('#me-cant').value) || 0);
    const nuevoResp  = qs('#me-resp-edit').value;
    const nuevaObs   = qs('#me-obs').value.trim();

    // Localizar egreso original
    const egresos = getEgresos();
    const idx = egresos.findIndex(x=>x.prodId===currentKey.prodId && x.fecha===currentKey.fecha);
    if (idx === -1){ toast('No se encontró el registro original.'); return; }

    // Ajuste de stock (egreso: disminuye stock). Delta = nueva - anterior.
    const anteriorCant = Number(egresos[idx].cant) || 0;
    const delta = nuevaCant - anteriorCant;
    const productos = getProductos();
    const p = productos.find(pp=>pp.id === prodId);
    if (p){
      // si delta > 0, estamos egresando más → bajar stock; si delta < 0, devolvemos stock
      p.stock = +(Number(p.stock) - delta).toFixed(2);
      saveProductos(productos);
    }

    // Actualizar registro
    egresos[idx] = {
      ...egresos[idx],
      // ID del egreso == ID del producto (no lo cambiamos)
      id: prodId,
      prodId: prodId,
      fecha: nuevaFecha || egresos[idx].fecha,
      cant:  nuevaCant,
      respId: nuevoResp || egresos[idx].respId,
      obs:   nuevaObs
    };
    saveEgresos(egresos);

    // Reset clave y refrescar
    currentKey = { prodId: egresos[idx].prodId, fecha: egresos[idx].fecha };
    toast('Cambios guardados');
    applyFilters();
  }

  function cancelEdit(){
    currentKey = null;
    qs('#me-form').reset();
    qs('#me-eid').value = '';
  }

  // ========= Init =========
  function init(){
    seedOnce();
    setDefaultDates();
    renderTiposFiltro();
    renderResponsablesFiltro();

    // Filtros
    qs('#me-filtros').addEventListener('submit', e=>{ e.preventDefault(); applyFilters(); });
    qs('#me-filtros').addEventListener('reset', ()=>{
      setTimeout(()=>{ setDefaultDates(); renderTiposFiltro(); renderResponsablesFiltro(); applyFilters(); }, 0);
    });

    // Edición
    qs('#me-form').addEventListener('submit', saveForm);
    qs('#me-cancel').addEventListener('click', cancelEdit);

    // Primera carga
    applyFilters();
  }

  document.addEventListener('DOMContentLoaded', init);
})();
</script>

  
</body>
</html>
